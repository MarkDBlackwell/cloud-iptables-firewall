IPv6 firewall (by hand) on Debian lenny VM, howto

OVERVIEW:

Recently, I set up a software firewall by hand for a virtual machine (VM) instance running Debian lenny.

Of concern (now or in future) is IPv6 traffic. My particular VM provider has not (completely, so far) enabled this. However, one's firewall should be prepared in advance, for whenever they do.

'You might think that [using iptables to] disallow incoming connections to your server on port 22 except from a single trusted IP ... is sufficient to stop connections hitting your machine, but if it is accessible over IPv6 you'll soon discover this isn't the case,' says 'Is your firewall aware?': http://www.debian-administration.org/articles/622.

The shorewall6 package implements an IPv6 firewall, which requires kernel 2.6.24 or later:
http://www.shorewall.net/IPv6Support.html

However, my particular VM provider gives me only kernel 2.6.18.


'Linux kernels before 2.6.20 didn't support connection tracking for IPv6' per:
http://www.shorewall.net/FAQ.htm#faq80a

It is hard to find IPv6 capable firewalls.

The following method allows full and easy control over IP addresses, protocols and ports.

In order to simplify, it leaves out denial of service (DOS) protection, because that seems unlikely in casual VM use.

It assumes your VM's IP address is IPv4.

BTW, it is impossible for it accidentally to lock you out, because VM providers naturally offer direct console access, independent of whatever services are running on the VM.

Legal note: THIS INFORMATION IS FOR EDUCATIONAL PURPOSES ONLY; I SHALL NOT BE HELD RESPONSIBLE FOR ANY DAMAGES POSSIBLY INCURRED!

The Iptables script was derived, with additions, from James Turnbull's 'Bastion Host IPTables Script' (see References).

IPv6:

Firewalling IPv6 traffic is a concern, either now or in the future when IPv6 becomes available to a VM.

Part of this concern is any IPv6 traffic tunnelled through IPv4 (either by ISATAP or Microsoft's Teredo).

Generally (but I am unable to test this), IPv6 traffic protection involves the same commands as IPv4, but given to a different program.

Therefore, this firewall attempts to work whether or not you have IPv6 (however, again, untested). If you have IPv6, it will attempt to include it.

If or when you receive notice from your VM provider that they have added IPv6 support, or if you add it yourself, then rerun:

$ /etc/init.d/iptables halt
$ /root/firewall/minimal.sh
$ /etc/init.d/iptables save
$ /etc/init.d/iptables start

General instructions:

First, make sure you have installed the Debian package, 'iptables':
$ aptitude install iptables

Now you can lock down your system:
$ /etc/init.d/iptables halt

If for any reason (before finishing) you need to access the Internet, just do:
$ /etc/init.d/iptables clear

Make a directory for your firewall scripts:
$ mkdir /root/firewall
$ cd /root/firewall

Create an executable file, 'minimal.sh' ...:
$ touch minimal.sh
$ chmod u+x minimal.sh

containing the following:
...
(end of minimal.sh)

Good, keep:
http://www.cyberciti.biz/tips/linux-iptables-8-how-to-avoid-spoofing-and-bad-addresses-attack.html

References:
Bastion Host IPTables Script:
Appendix A (or chapter 2) of James Turnbull's book, _Hardening Linux_. For download, see http://www.apress.com.

Firewalls on Debian:
http://wiki.debian.org/DebianFirewall
http://wiki.debian.org/Firewalls

Iptables (Debian package) and init:
https://help.ubuntu.com/community/IptablesHowTo

Init:
http://www.debian.org/doc/debian-policy/ch-opersys.html#s-sysvinit

IPv6:
http://madduck.net/docs/ipv6/
http://www.melb.apana.org.au/wiki/IPv6ConfigurationForDebian
http://tldp.org/HOWTO/Linux+IPv6-HOWTO/systemcheck-kernel.html
Is your firewall IPv6 aware?:
http://www.debian-administration.org/articles/622
http://www.networkworld.com/news/2009/071309-rogue-ipv6.html
http://en.wikipedia.org/wiki/List_of_IP_protocol_numbers
http://technet.microsoft.com/en-us/library/bb726956.aspx

http://www.cyberciti.biz/tips/linux-iptables-10-how-to-block-common-attack.html
http://www.cyberciti.biz/tips/linux-iptables-how-to-specify-a-range-of-ip-addresses-or-ports.html
http://www.cyberciti.biz/tips/linux-iptables-8-how-to-avoid-spoofing-and-bad-addresses-attack.html
http://www.tty1.net/blog/2007-02-06-iptables-firewall_en.html
http://blog.dustintrammell.com/2008/06/27/the-internet-is-a-dirty-dirty-mistress/
http://www.howtoforge.com/linux_iptables_sarge
http://www.thegeekstuff.com/scripts/iptables-rules
http://linuxconfig.org/collection-of-basic-linux-firewall-iptables-rules
http://tools.ietf.org/html/draft-ietf-mext-firewall-vendor-05
http://technet.microsoft.com/en-us/library/bb726956.aspx
http://en.wikipedia.org/wiki/ISATAP
http://en.wikipedia.org/wiki/IPv6
http://en.wikipedia.org/wiki/Teredo_tunneling
http://en.wikipedia.org/wiki/6to4
http://en.wikipedia.org/wiki/6in4
http://en.wikipedia.org/wiki/Anything_In_Anything
http://en.wikipedia.org/wiki/Local_area_network
http://www.debian.org/doc/manuals/securing-debian-howto/ch4.en.html
http://links2world.sourceforge.net/doc/links2world-Firewall-HOWTO/ch03s03.html
http://links2world.sourceforge.net/doc/links2world-Firewall-HOWTO/index.html
http://www.debian.org/doc/manuals/securing-debian-howto/ch4.en.html#s-network-secure
/usr/src/linux/Documentation/filesystems/proc.txt
/usr/src/linux/Documentation/networking/ip-sysctl.txt
http://druid.caughq.org/projects/dfw/

Teredo:
For client inquiries to server: UDP destination port is 3544.

http://web.luchs.at/article.php?cat=2&aid=298
http://www.symantec.com/avcenter/reference/Teredo_Security.pdf
http://linux.die.net/man/8/miredo

http://www.getipv6.info/index.php/IPv6_Firewalls
http://www.sixxs.net/wiki/IPv6_Firewalling
http://en.wikipedia.org/wiki/Iptables
http://www.thegeekstuff.com/2010/02/top-5-best-linux-firewalls/

Reasons to use IPv6:
http://en.linuxreviews.org/Why_you_want_IPv6
http://www.bieringer.de/linux/IPv6/IPv6-HOWTO/IPv6-HOWTO-8.html
http://www.tldp.org/HOWTO/Linux+IPv6-HOWTO/x2228.html#AEN2236
